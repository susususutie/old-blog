<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>02-cookie应用实例</title>
</head>

<body>
    <form>
        <input type="text" id="username" autocomplete="off">
        <input type="text" id="passworld" autocomplete="off">
        <input type="submit" value="登录" id="login">
    </form>

    <script>
        var usernameInput = document.getElementById("username");
        var passworldInput = document.getElementById("passworld");
        var login = document.getElementById("login");
        var ifSignUp = true;

        // cookie操作方法
        var manageCookie = {
            setCookie: function (name, value, maxAge) {
                document.cookie = `${name}=${value}; max-age=${maxAge}`;
                return this;
            },
            removeCookie: function (name) {
                return this.setCookie(name, "", -1);
            },
            getCookie: function (name, callback) {
                var cookiesArr = document.cookie.split("; ");
                for (var i = 0; i < cookiesArr.length; i++) {
                    var item = cookiesArr[i].split("=");
                    if (item[0] == name) {
                        callback(item[1])
                        return this;
                    }
                }
                callback(undefined)
                return this;
            }
        }

        // 登录函数，判定账号密码是否正确
        function mylogin(username, passworld) {
            manageCookie.getCookie("username", function (trueName) {
                if (username == trueName) {
                    manageCookie.getCookie("passworld", function (truePass) {
                        if (passworld == truePass) {
                            location.href = "./login.html";
                        } else {
                            window.alert("密码错误，请重新输入。")
                        }
                    })
                } else {
                    window.alert("用户出错，请检查输入是否有误。")
                }
            })
        }


        // 先判断是否注册过，没有显示注册按钮，否则显示登录按钮
        function hasSignUp() {
            manageCookie.getCookie("username", function (namedata) {
                if (namedata) {
                    ifSignUp = true;
                    usernameInput.value = namedata;
                    // manageCookie.getCookie("passworld", function (passdata) {
                    //     passworldInput.value = passdata;
                    // })
                    login.value = "登录";
                } else {
                    ifSignUp = false;
                    usernameInput.value = "";
                    passworldInput.value = "";
                    login.value = "注册";
                }
            })
        }

        // first 
        hasSignUp()

        // second click btn
        login.onclick = function (e) {
            e.preventDefault();
            if (ifSignUp) {
                // 注册过
                var username = usernameInput.value;
                var passworld = passworldInput.value;
                if (username && passworld) {
                    mylogin(username, passworld)
                } else {
                    window.alert("请输入密码再登录")
                }
            } else {
                // 没注册过
                var username = usernameInput.value;
                var passworld = passworldInput.value;
                if (username && passworld) {
                    manageCookie.setCookie("username", username, 3000000)
                            .setCookie("passworld", passworld, 3000000)
                    window.alert("注册成功！")
                    hasSignUp()
                } else {
                    window.alert("请先输入账号、密码再点击注册")
                }
            }
        }
    </script>
</body>

</html>